version: "3.9"  # Compose schema version

services:
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ğŸ§ Lavalink (audio node)
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    lavalink:
        build:
            context: ./lavalink            # Path to your custom Lavalink Dockerfile
            dockerfile: Dockerfile         # Custom Dockerfile that bakes in the YouTube plugin
            args:
                - YT_PLUGIN_VER=1.16.0     # Pinned plugin version; bump only when you intentionally upgrade
        container_name: lavalink
        restart: unless-stopped            # Auto-restart unless manually stopped (production best practice)
        environment:
            - JAVA_TOOL_OPTIONS=-Xms256m -Xmx1024m    # JVM memory limits to prevent OOM crashes
            - LAVALINK_PASSWORD=${LAVALINK_PASSWORD}  # Lavalink auth password (set in Coolify)
            - YOUTUBE_REFRESH_TOKEN=${YOUTUBE_REFRESH_TOKEN}  # OAuth token for YouTube Source
            - YTCIPHER_PASSWORD=${YTCIPHER_PASSWORD}          # Password for yt-cipher service
        depends_on:
            yt-cipher:
                condition: service_started  # Lavalink waits until yt-cipher starts (not necessarily healthy yet)
        volumes:
            - ./lavalink/application.yml:/opt/Lavalink/application.yml:ro  # Mount config as read-only
            - lavalink-data:/data          # Persist Lavalink logs and cache data
        healthcheck:
            # Lavalink healthcheck â€” verifies it responds on /v4/info
            test: ["CMD-SHELL", "if [ ! -f /tmp/hc_once ]; then wget -qO- --header='Authorization: ${LAVALINK_PASSWORD}' http://127.0.0.1:2333/v4/info >/dev/null 2>&1 || exit 1; touch /tmp/hc_once; fi"]
            interval: 5s                   # Check every 5 seconds
            timeout: 3s                    # Fail after 3 seconds if no response
            retries: 30                    # Retry up to 30 times
            start_period: 10s              # Wait 10 seconds before first check

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ğŸ” YouTube Cipher microservice
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    yt-cipher:
        image: ghcr.io/kikkia/yt-cipher:master  # Pull latest stable yt-cipher image
        container_name: yt-cipher
        restart: unless-stopped
        environment:
            - PASSWORD=${YTCIPHER_PASSWORD}  # Shared secret with Lavalink plugin
            - PORT=8001                      # Internal port; Lavalink uses http://yt-cipher:8001
        # No ports exposed â€” this service is only accessed internally via Docker network

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ğŸ¤– Discord bot (Lotoi)
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    lotoi-bot:
        build:
            context: .                       # Project root (contains Dockerfile for the bot)
            dockerfile: ./Dockerfile
        container_name: lotoi-bot
        depends_on:
            lavalink:
                condition: service_healthy    # Only start once Lavalink passes its healthcheck
        restart: unless-stopped
        env_file:
            - .env                            # Optional local env file (Coolify overrides take priority)
        environment:
            # Lavalink connection parameters
            - LAVALINK_HOST=${LAVALINK_HOST}
            - LAVALINK_PORT=${LAVALINK_PORT}
            - LAVALINK_PASSWORD=${LAVALINK_PASSWORD}
            # Other secrets (like DISCORD_TOKEN, MONGO_URI, etc.) should be in Coolify â†’ Environment Variables

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ“¦ Named volumes
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
volumes:
    lavalink-data:  # Stores Lavalinkâ€™s /data directory (logs, playback cache)
